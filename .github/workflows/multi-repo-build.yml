name: Multi-Repo Build

on:
  workflow_dispatch:
    inputs:
      repos:
        description: 'Space-separated list of GitHub repos (e.g., "ocaml-dune/notty ocaml/ocaml-re")'
        required: true
        type: string
      depext_linux:
        description: 'Space-separated apt packages for Linux (optional, falls back to dune show depexts)'
        required: false
        type: string
        default: ''
      depext_macos:
        description: 'Space-separated brew packages for macOS (optional, falls back to dune show depexts)'
        required: false
        type: string
        default: ''
      main_command:
        description: 'Main command to run (default: "dune build --display short")'
        required: false
        type: string
        default: 'dune build --display short'

env:
  EXTRA_NIX_CONFIG: |
    extra-substituters = https://anmonteiro.nix-cache.workers.dev
    extra-trusted-public-keys = ocaml.nix-cache.com-1:/xI2h2+56rwFfKyyFVbkJSeGqSIYMC/Je+7XXqGKDIY=

jobs:
  build:
    name: Build repos with Dune
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
    runs-on: ${{ matrix.os }}
    steps:
      - name: Print workflow inputs
        run: |
          echo "=== Multi-Repo Build Inputs ==="
          echo "Repos: ${{ inputs.repos }}"
          echo "Depext Linux: ${{ inputs.depext_linux || '(auto-detect)' }}"
          echo "Depext macOS: ${{ inputs.depext_macos || '(auto-detect)' }}"
          echo "Main command: ${{ inputs.main_command }}"
          echo "==============================="

      - name: Checkout Dune
        uses: actions/checkout@v6

      - name: Set up Nix
        uses: nixbuild/nix-quick-install-action@v34
        with:
          nix_conf: ${{ env.EXTRA_NIX_CONFIG }}

      - name: Cache Nix store
        uses: nix-community/cache-nix-action@v6
        with:
          primary-key: nix-${{ runner.os }}-nix-build--${{ hashFiles('**/*.nix', '**/flake.lock') }}
          restore-prefixes-first-match: nix-${{ runner.os }}-nix-build--
          save: false

      - name: Build Dune
        run: nix build

      - name: Set up workspace directory
        run: mkdir workspace

      - name: Clone repositories
        run: |
          cd workspace
          for repo in ${{ inputs.repos }}; do
            echo "Cloning $repo..."
            repo_name=$(echo $repo | sed 's/.*\///')
            git clone https://github.com/$repo.git $repo_name
          done

      - name: Generate dune-workspace
        run: |
          cd workspace
          cat > dune-workspace <<EOF
          (lang dune 3.21)
          (pkg enabled)
          EOF

          echo "Generated dune-workspace:"
          cat dune-workspace

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          if [ -n "${{ inputs.depext_linux }}" ]; then
            depexts="${{ inputs.depext_linux }}"
          else
            depexts=$(cd workspace && nix shell .. -c dune show depexts)
          fi
          if [ -n "$depexts" ]; then
            echo "Installing depexts: $depexts"
            sudo apt-get update
            sudo apt-get install -y $depexts
          fi

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          if [ -n "${{ inputs.depext_macos }}" ]; then
            depexts="${{ inputs.depext_macos }}"
          else
            depexts=$(cd workspace && nix shell .. -c dune show depexts)
          fi
          if [ -n "$depexts" ]; then
            echo "Installing depexts: $depexts"
            brew install $depexts
          fi

      - name: Run main command
        run: cd workspace && nix shell .. -c ${{ inputs.main_command }}
