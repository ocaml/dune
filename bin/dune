(executable
 (name main)
 (public_name dune)
 (package dune)
 (enabled_if
  (<> %{profile} dune-bootstrap))
 (libraries
  memo
  ocaml
  dune_lang
  fiber
  stdune
  dune_console
  unix
  dune_metrics
  dune_digest
  dune_cache
  dune_cache_storage
  dune_graph
  dune_rules
  dune_engine
  dune_util
  dune_upgrader
  cmdliner
  threads.posix
  build_info
  dune_config
  chrome_trace
  dune_stats
  csexp
  csexp_rpc
  dune_rpc_impl
  dune_rpc_private)
 (bootstrap_info bootstrap-info))

; Installing the dune binary depends on the kind of build:
; - for bootstrap builds, dune.exe is copied from ../dune.exe
;   and installed using a manual install stanza
; - for non-bootstrap builds (building dune with another dune),
;   the executable stanza does everything (and attached it to the
;   right package, which is important for build-info to succeed)
;   but we still need to setup a dummy dune.exe so that profiles
;   agree on the targets.

(rule
 (enabled_if
  (<> %{profile} dune-bootstrap))
 (action
  (with-stdout-to dune.exe (progn))))

(rule
 (action
  (copy ../dune.exe dune.exe))
 (enabled_if
  (= %{profile} dune-bootstrap)))

(install
 (section bin)
 (enabled_if
  (= %{profile} dune-bootstrap))
 (package dune)
 (files
  (dune.exe as dune)))

(deprecated_library_name
 (old_public_name dune.configurator)
 (new_public_name dune-configurator))
